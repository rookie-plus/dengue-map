<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>GE5219 - Real-time Dengue Risk Map for Singapore</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                         "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        .top-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.92);
            padding: 8px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .top-bar-title {
            font-size: 16px;
            font-weight: 600;
        }

        .top-bar-subtitle {
            font-size: 13px;
            color: #666;
        }

        .top-bar-members {
            font-size: 12px;
            color: #888;
        }

        .info.leaflet-control {
            padding: 8px 10px;
            font-size: 13px;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 8px;
            line-height: 1.4;
        }

        .info h4 {
            margin: 0 0 4px;
            font-size: 14px;
            font-weight: 600;
        }

        .info-options {
            margin-top: 4px;
            margin-bottom: 4px;
        }

        .info-options-row {
            display: block;
            margin-bottom: 2px;
        }

        .info-options-row label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .info-options-row input[type="checkbox"] {
            margin: 0;
        }

        .legend {
            line-height: 18px;
            color: #555;
        }
        .legend h4 {
            margin: 0 0 4px;
            font-size: 13px;
            font-weight: 600;
        }
        .legend i {
            width: 14px;
            height: 14px;
            float: left;
            margin-right: 8px;
            margin-top: 2px;
            opacity: 0.8;
            border-radius: 3px;
        }

        .source-note.leaflet-control {
            padding: 6px 8px;
            font-size: 11px;
            background: rgba(255,255,255,0.9);
            border-radius: 6px;
        }
        
        .leaflet-control-home a {
            background-image: url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23333"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg>');
            background-size: 18px 18px;
            background-position: center;
            background-repeat: no-repeat;
            width: 30px;
            height: 30px;
            display: block;
            border-radius: 4px;
        }
        .leaflet-control-home a:hover {
            background-color: #f4f4f4;
        }

        .leaflet-interactive {
            cursor: pointer;
        }

        /* 右下角变量对比框（放在 legend 上方） */
        .compare-box {
            margin-bottom: 6px;
            font-size: 12px;
        }
        .compare-box b {
            font-size: 13px;
        }
        .compare-box table {
            margin-top: 4px;
            font-size: 11px;
            border-collapse: collapse;
        }
        .compare-box th,
        .compare-box td {
            padding: 2px 6px;
            text-align: center;
            white-space: nowrap;
            border-bottom: 1px solid #eee;
        }
        .compare-box th {
            font-weight: 600;
        }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="top-bar-title">GE5219 – Real-time Dengue Risk Map for Singapore</div>
    <div class="top-bar-subtitle" id="update-time">Last update: loading…</div>
    <div class="top-bar-members">Group 4: Chen Lujie, Cui Wanqing, Liew Yu Wen Rachel, Xing Shixiang, Yang Bangshuo</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    // ============================================================
    // 全局常量与变量
    // ============================================================

    const GEOJSON_FILE = 'sg_subz_res_wgs84.geojson';
    const SG_CENTER = [1.3521, 103.8198];
    const SG_ZOOM = 11;

    const RISK_BREAKS = [0, 0.1, 0.2, 0.4, 0.6, 0.8];

    let currentProps = null;
    let riskLayer = null;
    let casesLayer = null;

    // 病例自然间断点（Jenks），4 级 -> 长度 5 的数组 [min, b1, b2, b3, max]
    let CASE_BREAKS = [];
    // 图例当前模式：'risk' 或 'cases'
    let legendMode = 'risk';

    const map = L.map('map').setView(SG_CENTER, SG_ZOOM);

    // ============================================================
    // 底图图层
    // ============================================================

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    });

    const darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors, © CartoDB'
    });

    osm.addTo(map);

    // ============================================================
    // 颜色与样式：风险系数
    // ============================================================

    function getColorRisk(d) {
        return d > 0.8 ? '#800026' :
               d > 0.6 ? '#BD0026' :
               d > 0.4 ? '#E31A1C' :
               d > 0.2 ? '#FC4E2A' :
               d > 0.1 ? '#FD8D3C' :
                         '#FFEDA0';
    }

    function getColorBlue(d) {
        return d > 0.8 ? '#0B3C5D' :
               d > 0.6 ? '#186BB3' :
               d > 0.4 ? '#2A9DF4' :
               d > 0.2 ? '#7FC8FF' :
               d > 0.1 ? '#B9E3FF' :
                         '#E6F4FF';
    }

    let currentColorFunction = getColorRisk;

    function style(feature) {
        const riskScore = feature.properties.dengue_coefficient || 0;
        return {
            fillColor: currentColorFunction(riskScore),
            weight: 1,
            opacity: 1,
            color: 'white',
            dashArray: '3',
            fillOpacity: 0.75
        };
    }

    // ============================================================
    // 病例图层配色：自然间断点 + 不同底图配色
    // ============================================================

    const CASE_COLORS_LIGHT = ['#f2f0f7', '#cbc9e2', '#9e9ac8', '#6a51a3']; // Standard 紫色
    const CASE_COLORS_DARK  = ['#f7fcf5', '#c7e9c0', '#41ab5d', '#006d2c']; // Dark 绿色

    // 病例颜色（根据 Jenks breaks + 0 case 单独白色）
    function getCasesColorFromBreaks(d, palette) {
        if (d == null || isNaN(d)) {
            return '#ffffff';  // 没有数据也白色
        }
        if (d === 0) {
            return '#ffffff';  // ✅ 0 个病例：纯白，不透明
        }

        if (!CASE_BREAKS || CASE_BREAKS.length < 2) {
            return '#cccccc';
        }
        if (d <= CASE_BREAKS[1]) return palette[0];
        if (d <= CASE_BREAKS[2]) return palette[1];
        if (d <= CASE_BREAKS[3]) return palette[2];
        return palette[3];
    }

    function getCasesColorLight(d) {
        return getCasesColorFromBreaks(d, CASE_COLORS_LIGHT);
    }

    function getCasesColorDark(d) {
        return getCasesColorFromBreaks(d, CASE_COLORS_DARK);
    }

    let currentCasesColorFunction = getCasesColorLight;

    function styleCases(feature) {
        const cases = feature.properties.CASE_SIZE || 0;

        return {
            fillColor: currentCasesColorFunction(cases),
            weight: 1,          // 不再根据是否为 0 改变粗细
            opacity: 1,
            color: '#e1e1e0',      // 统一边线颜色
            dashArray: '3',
            fillOpacity: 0.8    // ✅ 所有区域都实心、不再“透明”
        };
    }

    // ============================================================
    // Jenks 自然间断点算法（4 级）
    // ============================================================

    function jenks(data, n_classes) {
        // 拷贝并排序
        data = data.slice().sort((a, b) => a - b);
        const n_data = data.length;
        if (n_classes > n_data) n_classes = n_data;

        const mat1 = Array(n_data + 1).fill(0).map(() => Array(n_classes + 1).fill(0));
        const mat2 = Array(n_data + 1).fill(0).map(() => Array(n_classes + 1).fill(0));

        for (let i = 1; i <= n_classes; i++) {
            mat1[0][i] = 1;
            mat2[0][i] = 0;
            for (let j = 1; j <= n_data; j++) {
                mat2[j][i] = Infinity;
            }
        }

        let v = 0.0;

        for (let l = 2; l <= n_data; l++) {
            let s1 = 0.0;
            let s2 = 0.0;
            let w = 0;

            for (let m = 1; m <= l; m++) {
                const lowerClassLimit = l - m + 1;
                const val = data[lowerClassLimit - 1];

                s2 += val * val;
                s1 += val;
                w++;

                v = s2 - (s1 * s1) / w;

                const i4 = lowerClassLimit - 1;
                if (i4 !== 0) {
                    for (let j = 2; j <= n_classes; j++) {
                        if (mat2[l][j] >= (v + mat2[i4][j - 1])) {
                            mat1[l][j] = lowerClassLimit;
                            mat2[l][j] = v + mat2[i4][j - 1];
                        }
                    }
                }
            }

            mat1[l][1] = 1;
            mat2[l][1] = v;
        }

        const kclass = Array(n_classes + 1).fill(0);
        kclass[n_classes] = data[n_data - 1];
        kclass[0] = data[0];

        let k = n_data;
        for (let j = n_classes; j >= 2; j--) {
            const id = mat1[k][j] - 2;
            kclass[j - 1] = data[id];
            k = mat1[k][j] - 1;
        }

        return kclass;
    }

    function computeCaseBreaks(data) {
        const values = [];
        data.features.forEach(f => {
            const v = f.properties.CASE_SIZE;
            if (v != null && !isNaN(v) && v >= 0) {
                values.push(v);
            }
        });

        if (values.length === 0) {
            CASE_BREAKS = [];
            return;
        }

        const nClasses = Math.min(4, values.length);
        CASE_BREAKS = jenks(values, nClasses);
        // console.log('CASE_BREAKS', CASE_BREAKS);
    }

    // ============================================================
    // 重置视图按钮
    // ============================================================

    const HomeControl = L.Control.extend({
        options: { position: 'topleft', title: 'Reset view' },
        onAdd: function(map) {
            const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-home');
            const link = L.DomUtil.create('a', '', container);
            link.href = '#';
            link.title = this.options.title;
            
            L.DomEvent.on(link, 'click', L.DomEvent.stop)
                      .on(link, 'click', () => {
                          map.setView(SG_CENTER, SG_ZOOM);
                      });

            return container;
        },
        onRemove: function(map) {}
    });
    new HomeControl().addTo(map);

    // ============================================================
    // 右上角：变量勾选
    // ============================================================

    const varsPanel = L.control({position: 'topright'});
    varsPanel.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'info');

        div.innerHTML = `
            <h4>Subzone dengue risk</h4>
            <div style="font-size:12px; margin-bottom:4px;">
                Select variables to display:
            </div>
            <div class="info-options">
                <div class="info-options-row">
                    <label>
                        <input type="checkbox" id="select-all-variables">
                        <b>Select all</b>
                    </label>
                </div>
                <div class="info-options-row">
                    <label>
                        <input type="checkbox" data-field="CASE_SIZE" data-label="Active cases" checked>
                        Active cases
                    </label>
                </div>
                <div class="info-options-row">
                    <label>
                        <input type="checkbox" data-field="temp" data-label="Air temperature (°C)" checked>
                        Air temperature (°C)
                    </label>
                </div>
                <div class="info-options-row">
                    <label>
                        <input type="checkbox" data-field="rain" data-label="Rainfall (mm)" checked>
                        Rainfall (mm)
                    </label>
                </div>
                <div class="info-options-row">
                    <label>
                        <input type="checkbox" data-field="pop_den" data-label="Population density" checked>
                        Population density
                    </label>
                </div>
                <div class="info-options-row">
                    <label>
                        <input type="checkbox" data-field="ndvi" data-label="NDVI" checked>
                        NDVI
                    </label>
                </div>
            </div>
        `;

        L.DomEvent.disableClickPropagation(div);

        const selectAllCb = div.querySelector('#select-all-variables');
        const varCbs = div.querySelectorAll('.info-options input[type="checkbox"][data-field]');

        function updateSelectAllState() {
            const total = varCbs.length;
            let checkedCount = 0;
            varCbs.forEach(cb => { if (cb.checked) checkedCount++; });

            if (checkedCount === 0) {
                selectAllCb.checked = false;
                selectAllCb.indeterminate = false;
            } else if (checkedCount === total) {
                selectAllCb.checked = true;
                selectAllCb.indeterminate = false;
            } else {
                selectAllCb.checked = false;
                selectAllCb.indeterminate = true;
            }
        }

        updateSelectAllState();

        selectAllCb.addEventListener('change', () => {
            const checked = selectAllCb.checked;
            selectAllCb.indeterminate = false;
            varCbs.forEach(cb => { cb.checked = checked; });
            detailsPanel.update(currentProps);
            compareBox.update(currentProps);
        });

        varCbs.forEach(cb => {
            cb.addEventListener('change', () => {
                updateSelectAllState();
                detailsPanel.update(currentProps);
                compareBox.update(currentProps);
            });
        });

        return div;
    };
    varsPanel.addTo(map);

    // ============================================================
    // 右上角详情面板
    // ============================================================

    const detailsPanel = L.control({position: 'topright'});
    detailsPanel.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info');
        this._div.innerHTML = 'Hover over a subzone';
        L.DomEvent.disableClickPropagation(this._div);
        return this._div;
    };

    detailsPanel.update = function(props) {
        if (!this._div) return;
        const div = this._div;

        if (!props) {
            div.innerHTML = 'Hover over a subzone';
            return;
        }

        let html = '';
        const name = props.subzone || 'Unknown subzone';
        const riskVal = (props.dengue_coefficient != null && !Number.isNaN(props.dengue_coefficient))
            ? props.dengue_coefficient.toFixed(3)
            : 'N/A';

        html += `<b>${name}</b><br/>`;
        html += `Risk coefficient: <b>${riskVal}</b><br/>`;

        const checkboxes = document.querySelectorAll('.info-options input[type="checkbox"][data-field]');
        checkboxes.forEach(cb => {
            if (!cb.checked) return;
            const field = cb.getAttribute('data-field');
            const label = cb.getAttribute('data-label');
            let value = props[field];

            if (value == null || Number.isNaN(value)) {
                value = 'N/A';
            } else if (typeof value === 'number') {
                if (field === 'CASE_SIZE' || field === 'pop_den') {
                    value = value.toFixed(0);
                } else {
                    value = value.toFixed(3);
                }
            }

            html += `${label}: ${value}<br/>`;
        });

        div.innerHTML = html;
    };

    detailsPanel.addTo(map);

    // ============================================================
    // 右下角 Risk vs Active cases 对比框
    // ============================================================

    const compareBox = L.control({ position: 'bottomright' });

    compareBox.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info compare-box');
        this._div.style.display = 'none';
        this.update(null);
        L.DomEvent.disableClickPropagation(this._div);
        return this._div;
    };

    compareBox.update = function (props) {
        if (!this._div) return;

        const activeCasesCb = document.querySelector('.info-options input[data-field="CASE_SIZE"]');

        if (!activeCasesCb || !activeCasesCb.checked) {
            this._div.style.display = 'none';
            this._div.innerHTML = '';
            return;
        }

        this._div.style.display = 'block';

        if (!props) {
            this._div.innerHTML =
                '<b>Risk vs Active cases</b><br/>' +
                '<span style="font-size:11px;color:#666;">Hover over a subzone to compare.</span>';
            return;
        }

        const name = props.subzone || 'This subzone';
        let riskVal = props.dengue_coefficient;
        let caseVal = props.CASE_SIZE;

        if (riskVal == null || Number.isNaN(riskVal)) {
            riskVal = 'N/A';
        } else {
            riskVal = riskVal.toFixed(3);
        }

        if (caseVal == null || Number.isNaN(caseVal)) {
            caseVal = 'N/A';
        } else {
            caseVal = caseVal.toFixed(0);
        }

        this._div.innerHTML = `
            <b>Risk vs Active cases</b><br/>
            <span style="font-size:12px;">${name}</span>
            <table>
                <tr>
                    <th>Risk coefficient</th>
                    <th>Active cases</th>
                </tr>
                <tr>
                    <td>${riskVal}</td>
                    <td>${caseVal}</td>
                </tr>
            </table>
        `;
    };

    // ============================================================
    // 交互事件
    // ============================================================

    function highlightFeature(e) {
        const layer = e.target;

        layer.setStyle({
            weight: 2,
            color: '#666',
            dashArray: '',
            fillOpacity: 0.9
        });

        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            layer.bringToFront();
        }

        currentProps = layer.feature.properties;
        detailsPanel.update(currentProps);
        compareBox.update(currentProps);
    }

    function resetHighlight(e) {
        const layer = e.target;

        if (riskLayer && riskLayer.hasLayer(layer)) {
            riskLayer.resetStyle(layer);
        } else if (casesLayer && casesLayer.hasLayer(layer)) {
            casesLayer.resetStyle(layer);
        }

        currentProps = null;
        detailsPanel.update(null);
        compareBox.update(null);
    }

    function zoomToFeature(e) {
        map.fitBounds(e.target.getBounds());
    }

    function onEachFeature(feature, layer) {
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: zoomToFeature
        });

        const risk = feature.properties.dengue_coefficient;
        const cases = feature.properties.CASE_SIZE;
        layer.bindPopup(
            '<b>' + (feature.properties.subzone || 'Unknown subzone') + '</b><br/>' +
            'Risk coefficient: ' + (risk != null && !Number.isNaN(risk) ? risk.toFixed(3) : 'N/A') + '<br/>' +
            'Active cases: ' + (cases != null && !Number.isNaN(cases) ? cases : 'N/A')
        );
    }

    // ============================================================
    // 加载 GeoJSON 数据
    // ============================================================

    fetch(GEOJSON_FILE)
        .then(response => {
            if (!response.ok) {
                throw new Error('Cannot load file: ' + GEOJSON_FILE);
            }
            return response.json();
        })
        .then(data => {
            // 先计算病例自然间断点
            computeCaseBreaks(data);

            // 风险图层
            riskLayer = L.geoJSON(data, {
                style: style,
                onEachFeature: onEachFeature
            }).addTo(map);

            // 病例图层
            casesLayer = L.geoJSON(data, {
                style: styleCases,
                onEachFeature: onEachFeature
            });

            map.fitBounds(riskLayer.getBounds());

            if (data.features && data.features.length > 0) {
                const t = data.features[0].properties.time;
                const timeEl = document.getElementById('update-time');
                if (t && timeEl) {
                    timeEl.textContent = 'Last update: ' + t;
                }
            }

            const baseMaps = {
                "Standard": osm,
                "Dark": darkMap
            };

            const overlayMaps = {
                "Dengue risk": riskLayer,
                "Real case distribution": casesLayer
            };

            L.control.layers(baseMaps, overlayMaps, { position: 'bottomleft' }).addTo(map);
        })
        .catch(error => {
            console.error('Failed to load GeoJSON:', error);
            alert('Map loading failed: ' + error.message);
        });

    // ============================================================
    // 图例（右下角）：在风险 / 病例之间切换
    // ============================================================

    const legend = L.control({ position: 'bottomright' });

    legend.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info legend');
        this.update();
        return this._div;
    };

    legend.update = function () {
        if (!this._div) return;

        // 风险图例
        if (legendMode === 'risk') {
            const grades = RISK_BREAKS;
            let labels = [];
            let html = '<h4>Dengue risk coefficient</h4>';

            for (let i = 0; i < grades.length; i++) {
                const from = grades[i];
                const to = grades[i + 1];

                labels.push(
                    '<i style="background:' + currentColorFunction(from + 0.0001) + '"></i> ' +
                    from.toFixed(1) + (to ? '&ndash;' + to.toFixed(1) : '+')
                );
            }

            html += labels.join('<br>');
            this._div.innerHTML = html;
            return;
        }

        // 病例图例（自然间断点）
        if (!CASE_BREAKS || CASE_BREAKS.length < 2) {
            this._div.innerHTML =
                '<h4>Active cases</h4>' +
                '<span style="font-size:11px;color:#666;">No case data.</span>';
            return;
        }

        let labels = [];
        let html = '<h4>Active cases (natural breaks)</h4>';

        for (let i = 0; i < CASE_BREAKS.length - 1; i++) {
            const from = CASE_BREAKS[i];
            const to   = CASE_BREAKS[i + 1];

            labels.push(
                '<i style="background:' + currentCasesColorFunction(from + 0.0001) + '"></i> ' +
                Math.round(from) + (to ? '&ndash;' + Math.round(to) : '+')
            );
        }

        html += labels.join('<br>');
        this._div.innerHTML = html;
    };

    legend.addTo(map);
    compareBox.addTo(map); // 在 legend 之后，显示在 legend 上方

    // ============================================================
    // 左下角数据来源说明
    // ============================================================

    const sourceNote = L.control({ position: 'bottomleft' });

    sourceNote.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'source-note');
        div.innerHTML =
            'Data: MOH / NEA; rainfall & temperature from data.gov.sg<br/>' +
            'Risk score aggregated at subzone level';
        return div;
    };

    sourceNote.addTo(map);

    // ============================================================
    // 底图切换：风险 & 病例颜色一起切
    // ============================================================

    map.on('baselayerchange', (e) => {
        if (e.name === 'Dark') {
            currentColorFunction = getColorBlue;
            currentCasesColorFunction = getCasesColorDark;
        } else {
            currentColorFunction = getColorRisk;
            currentCasesColorFunction = getCasesColorLight;
        }

        if (riskLayer) riskLayer.setStyle(style);
        if (casesLayer) casesLayer.setStyle(styleCases);

        legend.update();
    });

    // ============================================================
    // overlay 切换：控制图例模式 risk / cases
    // ============================================================

    map.on('overlayadd', function(e) {
        if (e.layer === casesLayer) {
            legendMode = 'cases';
            legend.update();
        } else if (e.layer === riskLayer) {
            legendMode = 'risk';
            legend.update();
        }
    });

    map.on('overlayremove', function(e) {
        if (e.layer === casesLayer && riskLayer && map.hasLayer(riskLayer)) {
            legendMode = 'risk';
            legend.update();
        } else if (e.layer === riskLayer && casesLayer && map.hasLayer(casesLayer)) {
            legendMode = 'cases';
            legend.update();
        }
    });

    // ============================================================
    // 比例尺
    // ============================================================

    L.control.scale({
        position: 'bottomleft',
        metric: true,
        imperial: false
    }).addTo(map);

</script>

</body>
</html>
